# é…ç½®ç³»ç»Ÿé‡æ„è¯´æ˜

## æ¦‚è¿°

å°†é…ç½®ç³»ç»Ÿé‡æ„ä¸º**å•ä¸€çœŸå®æ¥æº (Single Source of Truth)** æ¨¡å¼ã€‚ç°åœ¨ `status.yaml` æ˜¯å”¯ä¸€çš„é…ç½®æºï¼Œæ‰€æœ‰å…¶ä»–é…ç½®æ–‡ä»¶éƒ½ä»å®ƒç”Ÿæˆã€‚

## æ–‡ä»¶èŒè´£

### ğŸ“‹ data/status.yamlï¼ˆå”¯ä¸€çœŸå®æ¥æºï¼‰
**ç®¡ç†çŠ¶æ€æ å­—æ®µå…ƒæ•°æ®**

åŒ…å«ï¼š
- å­—æ®µå®šä¹‰å’Œç±»å‹çº¦æŸï¼ˆ`$enum`, `$range`, `$list`, `$ro`ï¼‰
- æ‰€æœ‰å­—æ®µçš„é»˜è®¤å€¼
- å­—æ®µçš„è¯¦ç»†è¯´æ˜ï¼ˆdescriptionï¼‰

ç¼–è¾‘æ–¹å¼ï¼š**ç¼–è¾‘æ­¤æ–‡ä»¶ä»¥æ›´æ–°ä»»ä½•é…ç½®**

ç¤ºä¾‹ï¼š
```yaml
ä¸–ç•Œ:
  description: "å½“å‰ä¸–ç•ŒçŠ¶æ€"
  fields:
    æ—¶é—´:
      type: "string"
      description: "ISO8601æ ¼å¼çš„æ—¥æœŸå’Œæ—¶é—´"
      default: "2024-12-16T14:30:00+0800"
    å •è½åº¦:
      type: "$range=[0,100]"
      description: "é“å¾·å •è½ç¨‹åº¦"
      default: 0
```

### ğŸ“¦ data/status.jsonï¼ˆç”¨äº Silly Tavern å¯¼å…¥ï¼‰
**åŒ…å«ç±»å‹å‰ç¼€ï¼Œç”¨äºæ•°æ®å¯¼å…¥**

åŒ…å«ï¼š
- æ‰€æœ‰å­—æ®µçš„é»˜è®¤å€¼
- **åŒ…å« White-X ç±»å‹å‰ç¼€**ï¼ˆ`$enum`, `$range`, `$list`, `$ro`ï¼‰
- ç”¨é€”ï¼šå¯¼å…¥åˆ° Silly Tavern ä¸­ä½œä¸ºè§’è‰²å¡æ•°æ®ä½¿ç”¨

âš ï¸ **ä¸åº”æ‰‹åŠ¨ç¼–è¾‘**

è‡ªåŠ¨ç”Ÿæˆï¼š`node build-config.js`

ç¤ºä¾‹ï¼š
```json
{
  "{{user}}": {
    "$enum={ä¸“ä¸š;èµ„æ·±;åå®¶} è¡Œä¸šç­‰çº§": "ä¸“ä¸š",
    "$range=[0,100] å •è½åº¦": 0,
    "å •è½åº¦æè¿°": "ä¸¥æ ¼éµå®ˆèŒä¸šæ“å®ˆ...",
    "$list æ‹æ‘„ä»»åŠ¡": [...]
  }
}
```

### ğŸ§ª data/status-vars.debug.jsonï¼ˆæœ¬åœ°æµ‹è¯•æ•°æ®ï¼‰
**çº¯æ•°æ®ç‰ˆæœ¬ï¼Œæ— ç±»å‹å‰ç¼€**

åŒ…å«ï¼š
- æ‰€æœ‰å­—æ®µçš„é»˜è®¤å€¼
- **ä¸åŒ…å«ç±»å‹å‰ç¼€**
- ç”¨é€”ï¼šç”¨äºæœ¬åœ°å¼€å‘æ—¶çš„æµ‹è¯•æ•°æ®
- ç¬¦åˆ "çŠ¶æ€æ " schema çš„ç»“æ„

âš ï¸ **ä¸åº”æ‰‹åŠ¨ç¼–è¾‘**

è‡ªåŠ¨ç”Ÿæˆï¼š`node build-config.js`

ç¤ºä¾‹ï¼š
```json
{
  "çŠ¶æ€æ ": {
    "å°äºŒ": {
      "è¡Œä¸šç­‰çº§": "ä¸“ä¸š",
      "å •è½åº¦": 0,
      "å •è½åº¦æè¿°": "ä¸¥æ ¼éµå®ˆèŒä¸šæ“å®ˆ...",
      "æ‹æ‘„ä»»åŠ¡": [...]
    }
  }
}
```

## å·¥ä½œæµ

### æ·»åŠ æˆ–ä¿®æ”¹å­—æ®µ

1. **ç¼–è¾‘ `data/status.yaml`**
   ```yaml
   {{user}}:
     fields:
       æ–°å­—æ®µ:
         type: "string"
         description: "å­—æ®µè¯´æ˜"
         default: "é»˜è®¤å€¼"
   ```

2. **è¿è¡Œæ„å»ºè„šæœ¬**
   ```bash
   pnpm config:build
   ```
   
   è¿™ä¼šè‡ªåŠ¨ç”Ÿæˆï¼š
   - `status.json`ï¼ˆå«ç±»å‹å‰ç¼€ï¼Œç”¨äº Silly Tavern å¯¼å…¥ï¼‰
   - `status-vars.debug.json`ï¼ˆæ— ç±»å‹å‰ç¼€ï¼Œç”¨äºæœ¬åœ°æµ‹è¯•ï¼‰

3. **éªŒè¯é…ç½®**
   ```bash
   pnpm config:verify
   ```
   
   æ£€æŸ¥ï¼š
   - schema å®šä¹‰æ˜¯å¦æœ‰æ•ˆ
   - æ‰€æœ‰å­—æ®µæ˜¯å¦æœ‰é»˜è®¤å€¼
   - é»˜è®¤å€¼æ˜¯å¦ç¬¦åˆç±»å‹çº¦æŸ

### ä¿®æ”¹å­—æ®µçš„é»˜è®¤å€¼

ç›´æ¥ç¼–è¾‘ `status.yaml` ä¸­çš„ `default` å€¼ï¼Œç„¶åè¿è¡Œ `pnpm config:build`ã€‚

### ä¿®æ”¹å­—æ®µçš„çº¦æŸ

ç¼–è¾‘ `status.yaml` ä¸­çš„ `type` å­—æ®µã€‚ä¾‹å¦‚ï¼š

```yaml
å •è½åº¦:
  type: "$range=[0,100]"  # ä¿®æ”¹èŒƒå›´
  default: 0
```

ç„¶åè¿è¡Œï¼š
```bash
pnpm config:build && pnpm config:verify
```

## å¥½å¤„

âœ… **å•ä¸€æ¥æº** - æ‰€æœ‰é…ç½®ä¿¡æ¯åœ¨ä¸€ä¸ªåœ°æ–¹ï¼ˆstatus.yamlï¼‰  
âœ… **å‡å°‘é‡å¤** - ä¸éœ€è¦åœ¨å¤šä¸ªæ–‡ä»¶ä¸­ç»´æŠ¤ç›¸åŒçš„çº¦æŸ  
âœ… **è‡ªåŠ¨åŒæ­¥** - æ„å»ºè„šæœ¬è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰æ´¾ç”Ÿæ–‡ä»¶  
âœ… **æ˜“äºç»´æŠ¤** - ä¿®æ”¹é…ç½®åªéœ€ç¼–è¾‘ status.yaml  
âœ… **å®Œæ•´æ–‡æ¡£** - `description` å­—æ®µä¸ºæ¯ä¸ªå­—æ®µæä¾›è¯´æ˜  
âœ… **åŒç”¨é€”æ”¯æŒ** - åŒæ—¶æ”¯æŒ Silly Tavern å¯¼å…¥å’Œæœ¬åœ°æµ‹è¯•  

## ç±»å‹çº¦æŸå‚è€ƒ

### åŸºæœ¬ç±»å‹
```yaml
å­—æ®µå:
  type: "string"    # å­—ç¬¦ä¸²
  type: "number"    # æ•°å­—
  type: "object"    # å¯¹è±¡
```

### White-X ç‰¹æ®Šç±»å‹
```yaml
å­—æ®µå:
  type: "$ro"                    # åªè¯»
  type: "$range=[0,100]"         # æ•°å€¼èŒƒå›´
  type: "$enum={é€‰é¡¹1;é€‰é¡¹2}"    # æšä¸¾
  type: "$list"                  # åˆ—è¡¨
```

## è„šæœ¬è¯´æ˜

### build-config.js
ç”Ÿæˆé…ç½®æ–‡ä»¶

```bash
node build-config.js
```

æµç¨‹ï¼š
1. ä» `status.yaml` è¯»å– schema å’Œé»˜è®¤å€¼
2. æå–é»˜è®¤å€¼ï¼Œç”Ÿæˆ `status.json`
3. æ·»åŠ ç±»å‹å‰ç¼€ï¼Œç”Ÿæˆ `status-vars.debug.json`

### verify-config.js
éªŒè¯é…ç½®çš„å®Œæ•´æ€§

```bash
node verify-config.js
```

æ£€æŸ¥ï¼š
- YAML æ˜¯å¦æœ‰æ•ˆ
- æ‰€æœ‰å­—æ®µæ˜¯å¦æœ‰ `default` å€¼
- é»˜è®¤å€¼æ˜¯å¦ç¬¦åˆç±»å‹çº¦æŸ
- ç”Ÿæˆçš„æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ

### npm è„šæœ¬
```bash
pnpm config:build    # è¿è¡Œ build-config.js
pnpm config:verify   # è¿è¡Œ verify-config.js
```

## è¿ç§»æŒ‡å—

å¦‚æœä»æ—§çš„é…ç½®ç³»ç»Ÿè¿ç§»ï¼š

1. æ›´æ–° `status.yaml`ï¼š
   - æ·»åŠ æ‰€æœ‰å­—æ®µçš„ `default` å€¼
   - æ·»åŠ  `description` è¯´æ˜
   - éªŒè¯ç±»å‹çº¦æŸ

2. æ¸…ç† `status.json`ï¼š
   - ç§»é™¤æ‰€æœ‰çš„ç±»å‹å‰ç¼€
   - ä»…ä¿ç•™å­—æ®µå€¼

3. è¿è¡Œæ„å»ºå’ŒéªŒè¯ï¼š
   ```bash
   node build-config.js
   node verify-config.js
   ```

## ç¤ºä¾‹æµç¨‹

### å¼€å‘æµç¨‹

```bash
# 1. ç¼–è¾‘ status.yamlï¼ˆæ·»åŠ æ–°å­—æ®µæˆ–ä¿®æ”¹å€¼ï¼‰
vim data/status.yaml

# 2. ç”Ÿæˆæ–°çš„é…ç½®æ–‡ä»¶
pnpm config:build

# 3. éªŒè¯é…ç½®çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§
pnpm config:verify

# 4. æäº¤æ›´æ”¹
git add data/status.yaml
git commit -m "Update configuration"
```

### å¯¼å‡ºåˆ° Silly Tavern

```bash
# 1. ç¡®ä¿ status.json æ˜¯æœ€æ–°çš„
pnpm config:build

# 2. å¤åˆ¶ status.json åˆ° Silly Tavern
#    status.json åŒ…å«ç±»å‹å‰ç¼€ï¼Œå¯ç›´æ¥ç”¨äºå¯¼å…¥
cp data/status.json /path/to/silly-tavern/characters/
```

## å¸¸è§é—®é¢˜

**Q: status.json å’Œ status-vars.debug.json æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**
A: 
- `status.json`ï¼šåŒ…å«ç±»å‹å‰ç¼€ï¼Œç”¨äºå¯¼å…¥åˆ° Silly Tavern
- `status-vars.debug.json`ï¼šæ— ç±»å‹å‰ç¼€ï¼Œç”¨äºæœ¬åœ°å¼€å‘æµ‹è¯•

**Q: å¦‚æœæˆ‘æ‰‹åŠ¨ç¼–è¾‘ status.json ä¼šæ€æ ·ï¼Ÿ**
A: ä¸‹æ¬¡è¿è¡Œ `pnpm config:build` æ—¶ï¼Œæ‚¨çš„ç¼–è¾‘ä¼šè¢«è¦†ç›–ã€‚è¯·æ”¹ä¸ºç¼–è¾‘ `status.yaml`ã€‚

**Q: æˆ‘éœ€è¦æ‰‹åŠ¨ç¼–è¾‘ status-vars.debug.json å—ï¼Ÿ**
A: ä¸éœ€è¦ã€‚å®ƒæ˜¯è‡ªåŠ¨ç”Ÿæˆçš„ã€‚ä»»ä½•æ‰‹åŠ¨ç¼–è¾‘éƒ½ä¼šåœ¨ä¸‹æ¬¡è¿è¡Œ `pnpm config:build` æ—¶è¢«è¦†ç›–ã€‚

**Q: ä¸ºä»€ä¹ˆéœ€è¦ä¸¤ä¸ªç‰ˆæœ¬çš„æ•°æ®æ–‡ä»¶ï¼Ÿ**
A: 
- å¯¼å…¥åˆ° Silly Tavern éœ€è¦ç±»å‹å‰ç¼€ï¼ˆ`$enum`, `$range` ç­‰ï¼‰
- æœ¬åœ°æµ‹è¯•éœ€è¦çº¯æ•°æ®ç‰ˆæœ¬ï¼ˆæ–¹ä¾¿ JavaScript å¤„ç†ï¼‰
- åŒä¸€ä¸ª yaml æºå¯ä»¥ç”Ÿæˆä¸¤ä¸ªç‰ˆæœ¬

**Q: å¦‚ä½•ä¿®æ”¹å¯¼å…¥åˆ° Silly Tavern çš„æ•°æ®ï¼Ÿ**
A: ç¼–è¾‘ `status.yaml`ï¼Œè¿è¡Œ `pnpm config:build`ï¼Œç„¶åå°†æ›´æ–°çš„ `status.json` å¯¼å…¥åˆ° Silly Tavernã€‚
