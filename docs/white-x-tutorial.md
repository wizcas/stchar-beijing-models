# 小白x变量系统教程

本教程旨在帮助你完全掌握小白x插件的变量系统，通过剧情互动动态记录、更新和触发事件。

## 核心功能概览

*   **消息内状态变更 (`<plot-log>`)**: 在AI回复中直接嵌入指令，实现对变量的实时增、删、改、查。
*   **变量守护 (`/xbsetvar`)**: 为变量设置写入规则（如只读、数值范围），防止AI误操作，确保剧情稳定性。
*   **世界书条件事件 (`<varevent>`)**: 根据变量状态自动触发特定文本或动作，实现高度动态的剧情分支。
*   **数值映射**: 将“开心”、“害羞”等自然语言自动转换为数值增减，让AI表达更自然。
*   **便捷工具**: 提供变量占位符、斜杠命令和AI遗忘时的自动补全功能，简化操作。

---

## 一、基础用法：在消息中变更状态

通过在AI回复中加入 `<plot-log>` 区块，你可以让AI记录剧情关键信息的变化。

### 四种核心操作

系统支持多种关键词别名，方便AI调用：

*   **`记下`** (set / 记录 / 录入 / record): 直接设置或覆盖一个变量的值。
*   **`调整`** (bump / 推移 / 变更 / adjust): 对数值类型的变量进行增加或减少。
*   **`追加`** (push / 添入 / 增录 / append): 向一个列表（数组）中添加新项目。
*   **`删除`** (del / 遗忘 / 抹去 / erase): 完全移除一个变量。

### 基本示例

一个简单的 `<plot-log>` 区块如下所示：

```yaml
<plot-log>
记下:
  好感度: 65
  心情: "害羞"
调整:
  约会次数: +1
追加:
  重要事件: ["第一次看电影"]
删除:
  临时标记
</plot-log>
```

### 支持的格式

系统支持多种主流数据格式，你可以选择最顺手的一种。

<details>
<summary><strong>点击查看四种等价格式示例</strong></summary>

#### 1. YAML (层级)
```yaml
<plot-log>
记下:
  角色状态:
    好感度: 65
    心情: "略显羞涩"
调整:
  剧情进度.约会次数: +1
追加:
  重要事件:
    - "第一次单独看电影"
删除:
  临时标记
</plot-log>
```

#### 2. YAML (点路径)
```yaml
<plot-log>
记下:
  角色状态.好感度: 65
  角色状态.心情: "略显羞涩"
调整:
  剧情进度.约会次数: +1
追加:
  重要事件: ["第一次单独看电影"]
删除:
  临时标记: true
</plot-log>
```

#### 3. JSON
```json
<plot-log>
{
  "记下": {
    "角色状态.好感度": 65,
    "角色状态.心情": "略显羞涩"
  },
  "调整": {
    "剧情进度.约会次数": 1
  },
  "追加": {
    "重要事件": ["第一次单独看电影"]
  }
}
</plot-log>
```

#### 4. TOML
```toml
<plot-log>
[记下]
角色状态.好感度 = 65
角色状态.心情 = "略显羞涩"

[调整]
剧情进度.约会次数 = 1

[追加]
重要事件 = ["第一次单独看电影"]
</plot-log>
```
</details>

### 状态一致性与自动回滚

> **核心保障**：你无需担心因编辑或删除消息导致变量错乱。

系统会自动处理消息的编辑、滑动替换和删除操作，确保变量状态始终准确：
*   **编辑消息**: 先回滚到该消息生效前的状态，再按新内容重新计算。
*   **滑动替换**: 同样先回滚，再应用新回复的内容。
*   **删除消息**: 直接回滚到被删除消息之前的变量状态。

---

## 二、变量守护：设置写入规则

此功能用于设定变量的修改权限，确保关键数据不被AI随意篡改。

### 基本原则

*   **默认行为**: 默认情况下，AI只能**修改已有变量的值**。不允许新增或删除对象的键，也不允许增加或删除数组的项。
*   **激活规则**: 如需修改默认行为（例如，允许AI添加道具），必须使用 `/xbsetvar` 命令进行初始化或规则更新。
*   **规则语法**: 在变量的键名前添加 `$` 前缀来定义规则。规则一旦设定，将永久生效并受到守护。

### 规则前缀详解

#### 通用
*   `$ro`: **只读**。设定后，任何人都无法修改该变量的值。

#### 数值 (Number)
*   `$min=数字`: 允许的最小值。
*   `$max=数字`: 允许的最大值。
*   `$range=[最小,最大]`: 数值必须在此闭区间内，超出则自动修正。

#### 字符串 (String)
*   `$enum={A;B;C}`: 值必须是预设选项之一。
*   `$match=/regex/flags`: 值必须匹配指定的正则表达式。

#### 对象 (Object)
*   `$ext`: **扩展 (只进不出)**。允许新增键，但不能删除已有键。
*   `$prune`: **修剪 (只出不进)**。允许删除已有键，但不能新增键。
*   `$free`: **自由**。允许随便增删键。
*   **默认**: 无前缀时，键不可新增也不可删除，保持结构锁定。

#### 数组 (Array)
*   `$grow`: **增长 (收集型)**。允许添加新项，但不能删除已有项。
*   `$shrink`: **缩减 (消耗型)**。允许删除已有项，但不能添加新项。
*   `$list`: **列表 (自由型)**。允许随便增删项。
*   **默认**: 无前缀时，项不可增加也不可删除，保持列表固定。

### 实用场景示例

<details>
<summary><strong>点击查看实用组合示例</strong></summary>

#### 游戏角色数值系统
```javascript
/xbsetvar key=角色 {
  "$ro 真名": "艾莉丝",              // 真名不可改
  "$range=[0,100] 生命": 100,       // 生命值0-100
  "$range=[0,100] 法力": 50,        // 法力值0-100  
  "$enum={战士;法师;盗贼} 职业": "法师",  // 只能这三种职业
  "$grow 经历": ["来到新世界"],       // 经历只能累积
  "$list 道具": ["魔法书", "药水"]    // 道具可增减
}
```

#### 恋爱模拟器
```javascript
/xbsetvar key=关系 {
  "$range=[0,100] 好感度": 60,           // 好感度0-100
  "$enum={陌生人;朋友;恋人;夫妻} 关系": "朋友",  // 关系阶段限定
  "$grow 甜蜜回忆": ["初次相遇"],         // 美好回忆只增不减
  "$list 约会地点": ["咖啡厅", "公园"]    // 约会地点可变
}
```

#### 学习进度追踪
```javascript
/xbsetvar key=学习 {
  "$range=[0,100] 进度": 30,         // 进度百分比
  "$ro 开始时间": "2024-01-15",      // 开始时间锁定
  "$grow 已学章节": ["第1章"],       // 学过的章节只增加
  "$shrink 剩余任务": ["作业1", "作业2"]  // 任务只能完成(删除)
}
```
</details>

### 规则效果

设置规则后，系统将自动守护变量：
*   AI尝试把好感度改成105？**自动拉回100**。
*   AI想删除角色真名？**拒绝操作**。
*   AI要把职业改成”猎人”？**操作失败**，值不符合`$enum`规则。
*   AI想删除重要回忆？**不允许**，`$grow`规则只许增加。

---

## 三、自动触发：世界书条件事件

使用 `<varevent>`，可以让世界书在满足特定变量条件时，自动为AI补充一段文字或在回复后执行一个动作。

### 可视化编辑器

> **无需手写代码！**
> 在世界书条目上点击“条件规则编辑器”按钮（尺子+笔图标），即可在图形化界面中完成所有配置。

### `<varevent>` 结构解析

编辑器会自动生成类似下方的代码：
```toml
<varevent>
[event.1]
# 条件：年龄为18且喜好为书籍
condition: var(`profile.age`) == val(`18`) && var(`profile.likes`) == val(`书籍`)
# 满足条件时插入的文本
display: "你注意到她正在读一本关于古代历史的书，似乎对这个话题很感兴趣。"
# 回复生成后执行的命令
js_execute: "STscript(`/setvar a=1`)"
</varevent>
```

### 事件优先级

*   **同一区块内**: 如果多个 `[event]` 条件同时满足，**只执行最后一条**。
*   **不同区块间**: 如果想让多个事件都生效，请将它们分别写在**不同的 `<varevent>` 区块**中。

<details>
<summary><strong>点击查看优先级示例</strong></summary>

```toml
<!-- 示例1：只会显示"你需要休息" -->
<varevent>
[event.1]
condition: var(`hp`) < 50
display: "你受了点伤"

[event.2] 
condition: var(`hp`) < 50
display: "你需要休息"
</varevent>

<!-- 示例2：两个提示都会显示 -->
<varevent>
[event.1]
condition: var(`hp`) < 50
display: "你受了点伤"
</varevent>

<varevent>
[event.2]
condition: var(`hp`) < 50  
display: "你需要休息"
</varevent>
```
</details>

### 生效时机

*   `display` (显示文本): 在构建AI提示词时插入，影响**当轮**生成内容。
*   `js_execute` (执行动作): 在AI回复**完成后**立即执行，不影响当轮文本。

---

## 四、进阶功能

### 1. 数值映射：自然语言转数值

此功能让你可以在 `<plot-log>` 中使用自然语言来表达数值变化。

*   **设置入口**: 世界书“条件规则编辑器” → “bump 数值映射设置”。
*   **配置格式**: `作用范围 | 词组或正则 | 数值`
    *   **作用范围**: 留空或写 `（全局）` 对所有变量生效；写具体变量名（如 `好感度`）则只对该变量生效。
    ```
    好感度 | /她(很)?害羞/i | 1
    好感度 | 生气 | -2
    （全局）| /非常?开心/ | 2
    ```
*   **使用效果**:
    ```yaml
    <plot-log>
    调整:
      好感度: 她很害羞    # 自动按 +1 处理
      心情值: 很开心      # 自动按 +2 处理
    </plot-log>
    ```

### 2. 变量占位符

在角色卡、世界书、消息和系统提示中，使用 `{{xbgetvar::变量路径}}` 来动态显示变量的当前值。
*   **示例**: `当前好感度：{{xbgetvar::关系.好感度}}`

### 3. 斜杠命令

*   `/xbgetvar 路径`: 快速读取并显示一个变量的值。
    *   **示例**: `/xbgetvar 关系.好感度`

### 4. plot-log 缺失补全

当AI忘记输出 `<plot-log>` 或结果不满意时，此功能可以救场。
*   **位置**: 仙女棒菜单 → “plot-log 缺失补全”。
*   **功能**:
    *   **单击**: 基于最近的对话上下文，自动生成 `<plot-log>` 并写入最后一条AI消息。
    *   **长按3秒**: 打开补全功能的API相关设置。

### 5. 自定义条件表达式 (高级)

除了可视化编辑器，你也可以在 `<varevent>` 中手写更复杂的JavaScript条件表达式。

> **提示**: 此部分适合高级用户。变量通常是字符串，进行数学运算时记得用 `parseInt()` 或 `parseFloat()` 转换类型。

<details>
<summary><strong>点击查看高级表达式示例与函数</strong></summary>

#### 示例
```js
// 多变量计算
condition: (parseInt(var(`玩家属性.智力`)) + parseInt(var(`玩家属性.体力`))) / 2 >= 10

// 复杂JS逻辑
condition: (() => {
  const intel = parseInt(var(`玩家属性.智力`)) || 0;
  const power = parseInt(var(`玩家属性.体力`)) || 0;
  // 复杂加权计算
  const weighted = (intel * 2 + power * 1.5) / 3.5;
  return weighted > 15;
})()

// 字符串与数值结合
condition: var(`玩家状态.职业`) === "法师" && (parseInt(var(`玩家属性.智力`)) + parseInt(var(`装备加成.智力`))) >= 25
```

#### 可用的操作符和函数
*   **数学**: `+`, `-`, `*`, `/`, `%`, `Math.floor()`, `Math.ceil()`, `Math.round()`
*   **比较**: `>`, `>=`, `<`, `<=`, `==`, `!=`, `===`, `!==`
*   **逻辑**: `&&`, `||`, `!`
*   **字符串**: `includes()`, `startsWith()`, `endsWith()`, `match()`
*   **数组**: `length`, `includes()`, `some()`, `every()`

#### 重要提示
*   **变量获取**: 用 `var()` 获取变量值，用 `val()` 包装字面值。
*   **类型转换**: 变量默认是字符串，数值计算前请用 `parseInt()` 或 `parseFloat()`。
*   **默认值**: 建议使用 `|| 0` 处理可能不存在的变量，避免计算出错。
</details>

---

## 五、完整流程示例：触发告白剧情

**目标**: 当 `好感度≥80` 且 `约会次数>5` 时，自动触发告白剧情。

1.  **日常对话积累变量**
    AI在日常互动中，通过 `<plot-log>` 持续更新变量。
    ```yaml
    <plot-log>
    调整:
      好感度: 她脸红了    # (事先配置映射：+2)
      约会次数: +1
    </plot-log>
    ```

2.  **设置世界书条件**
    使用“条件规则编辑器”设置触发条件：
    *   **条件1**: `关系.好感度` `>=` `80`
    *   **条件2**: `关系.约会次数` `>` `5`
    *   **显示文本**: `她低下头，小声问你明天是否还有空……`
    *   **执行动作**: `/setvar 解锁剧情.告白=true`

3.  **自动触发**
    当两个变量条件同时满足时，在下一轮对话中：
    *   你设置的“显示文本”会自动插入到给AI的提示词中，引导AI生成告白相关的回复。
    *   AI回复后，执行动作 `/setvar 解锁剧情.告白=true` 会被触发，正式解锁后续剧情。

---

## 六、常见问题 (FAQ)

**Q：一个 `<varevent>` 能同时触发多个事件吗？**
A：不能。在同一个 `<varevent>` 区块内，如果多条规则同时满足，只会触发**最后一条**。要让多个事件都生效，请将它们写在不同的 `<varevent>` 区块里。

**Q：数值映射在哪里配置？**
A：在世界书条目的“条件规则编辑器”里，有一个专门的“bump 数值映射设置”按钮。

**Q：可以直接给变量赋值吗？**
A：可以。`记下` 操作用于直接设置或覆盖值，而 `调整` 用于数值的增减。

**Q：编辑或删除消息后变量会乱吗？**
A：绝对不会。系统有完善的自动回滚机制，能确保变量状态始终与对话历史保持一致。